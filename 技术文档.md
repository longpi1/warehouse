# 仓库物流管理系统 - 技术文档

## 目录

- [1. 系统架构](#1-系统架构)
- [2. 技术栈详解](#2-技术栈详解)
- [3. 核心功能实现](#3-核心功能实现)
- [4. 数据库设计](#4-数据库设计)
- [5. API接口文档](#5-api接口文档)
- [6. 安全机制](#6-安全机制)
- [7. 部署指南](#7-部署指南)

---

## 1. 系统架构

### 1.1 整体架构

本系统采用经典的 **MVC 三层架构**，结合 Spring Boot 的约定优于配置理念，实现了高内聚、低耦合的设计。

```
┌─────────────────────────────────────────────────────┐
│                   前端层 (View)                      │
│              LayUI + Thymeleaf + jQuery              │
└────────────────────┬────────────────────────────────┘
                     │ HTTP/AJAX
┌────────────────────┴────────────────────────────────┐
│                 控制层 (Controller)                  │
│          Spring MVC + RESTful API                    │
└────────────────────┬────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────┐
│                 业务层 (Service)                     │
│              业务逻辑处理 + 事务管理                  │
└────────────────────┬────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────┐
│              持久层 (Mapper/DAO)                     │
│            MyBatis-Plus + MySQL                      │
└────────────────────┬────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────┐
│                   数据层 (Database)                  │
│                   MySQL 5.7+                         │
└─────────────────────────────────────────────────────┘
```

### 1.2 模块划分

系统分为两大核心模块：

#### **sys 模块** - 系统管理模块
- **common**: 通用工具类（常量、返回对象、文件工具等）
- **config**: 系统配置（Shiro、MyBatis-Plus）
- **controller**: 系统控制器（部门、菜单、权限、角色、用户）
- **domain**: 系统实体类
- **mapper**: 数据访问层
- **service**: 业务逻辑层
- **realm**: Shiro 认证授权
- **vo**: 视图对象（View Object）

#### **warehouse 模块** - 仓储业务模块
- **controller**: 业务控制器（客户、供应商、商品、进货、退货、发货）
- **domain**: 业务实体类
- **mapper**: 数据访问层
- **service**: 业务逻辑层
- **vo**: 视图对象

### 1.3 技术架构图

```
┌──────────────────────────────────────────────────────────┐
│                        前端技术栈                         │
│  LayUI (UI框架) + dtree (树组件) + jQuery (JS库)         │
└───────────────────────┬──────────────────────────────────┘
                        │
┌───────────────────────┴──────────────────────────────────┐
│                      安全框架层                           │
│    Apache Shiro (认证授权) + Session管理 + 密码加密      │
└───────────────────────┬──────────────────────────────────┘
                        │
┌───────────────────────┴──────────────────────────────────┐
│                     Spring Boot 核心                      │
│  Spring MVC + Spring AOP + Spring JDBC + Auto Config     │
└───────────────────────┬──────────────────────────────────┘
                        │
┌───────────────────────┴──────────────────────────────────┐
│                     持久化框架                            │
│  MyBatis-Plus (增强版MyBatis) + Druid (数据库连接池)     │
└───────────────────────┬──────────────────────────────────┘
                        │
┌───────────────────────┴──────────────────────────────────┐
│                     数据库层                              │
│              MySQL 5.7+ (关系型数据库)                   │
└──────────────────────────────────────────────────────────┘
```

---

## 2. 技术栈详解

### 2.1 后端技术栈

#### **Spring Boot 2.1.8.RELEASE**
- **作用**: 基础框架，提供自动配置、嵌入式服务器、依赖管理
- **核心特性**:
  - 自动配置 (Auto Configuration)
  - 起步依赖 (Starter Dependencies)
  - 内嵌 Tomcat 服务器
  - 简化的配置管理 (application.yml)

#### **MyBatis-Plus 3.2.0**
- **作用**: 增强型 ORM 框架
- **核心功能**:
  - 单表 CRUD 操作无需编写 XML
  - 条件构造器 (QueryWrapper)
  - 分页插件自动处理
  - 主键策略配置
  - 性能分析插件

**示例代码**:
```java
// 条件查询
QueryWrapper<Goods> queryWrapper = new QueryWrapper<>();
queryWrapper.eq("providerid", providerId)
            .like("goodsname", goodsName)
            .ge("number", 10);
List<Goods> goodsList = goodsService.list(queryWrapper);

// 分页查询
IPage<Customer> page = new Page<>(pageNum, pageSize);
customerService.page(page, queryWrapper);
```

#### **Apache Shiro 1.4.1**
- **作用**: 安全框架
- **核心功能**:
  - 认证 (Authentication)
  - 授权 (Authorization)
  - 会话管理 (Session Management)
  - 密码加密 (Cryptography)

**权限模型**: RBAC (Role-Based Access Control)
```
用户 (User) ←→ 角色 (Role) ←→ 权限 (Permission)
```

#### **Druid 1.1.18**
- **作用**: 数据库连接池
- **核心功能**:
  - 监控统计
  - SQL 防火墙
  - 慢SQL 分析
  - 连接池管理
  - 提供监控页面: `/druid/`

#### **其他技术组件**

| 组件 | 版本 | 功能 |
|------|------|------|
| Thymeleaf | Spring Boot默认 | 服务端模板引擎 |
| FastJSON | 1.2.61 | JSON序列化/反序列化 |
| Hutool | 4.6.6 | Java工具类库 |
| Pinyin4j | 2.5.1 | 中文转拼音 |
| Log4j | 1.2.17 | 日志框架 |
| Lombok | Latest | 简化实体类开发 |

### 2.2 前端技术栈

#### **LayUI 2.x**
- **特点**: 轻量级模块化前端框架
- **使用组件**:
  - layui.table - 数据表格
  - layui.form - 表单
  - layui.layer - 弹层
  - layui.tree - 树形组件（废弃，改用dtree）
  - layui.upload - 文件上传

#### **dtree**
- **作用**: LayUI 树形组件扩展
- **功能**: 
  - 树形结构展示
  - 复选框选择
  - 动态加载
  - 节点搜索

#### **jQuery**
- **版本**: 3.x
- **用途**: DOM 操作、AJAX 请求、事件处理

---

## 3. 核心功能实现

### 3.1 Shiro 权限控制

#### 3.1.1 Shiro 配置类

**文件**: `ShiroAutoConfiguration.java`

```java
@Configuration
@ConfigurationProperties(prefix = "shiro")
public class ShiroAutoConfiguration {
    // 散列算法配置
    private String hashAlgorithmName = "md5";
    private int hashIterations = 2;
    
    // 凭证匹配器
    @Bean("credentialsMatcher")
    public HashedCredentialsMatcher hashedCredentialsMatcher() {
        HashedCredentialsMatcher matcher = new HashedCredentialsMatcher();
        matcher.setHashAlgorithmName(hashAlgorithmName);
        matcher.setHashIterations(hashIterations);
        return matcher;
    }
    
    // UserRealm
    @Bean("userRealm")
    public UserRealm userRealm(CredentialsMatcher credentialsMatcher) {
        UserRealm userRealm = new UserRealm();
        userRealm.setCredentialsMatcher(credentialsMatcher);
        return userRealm;
    }
    
    // SecurityManager
    @Bean("securityManager")
    public SecurityManager securityManager(UserRealm userRealm) {
        DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();
        securityManager.setRealm(userRealm);
        return securityManager;
    }
    
    // Shiro 过滤器
    @Bean
    public ShiroFilterFactoryBean shiroFilterFactoryBean(SecurityManager securityManager) {
        ShiroFilterFactoryBean factoryBean = new ShiroFilterFactoryBean();
        factoryBean.setSecurityManager(securityManager);
        factoryBean.setLoginUrl(loginUrl);
        
        Map<String, String> filterChainDefinitionMap = new HashMap<>();
        // 匿名访问
        filterChainDefinitionMap.put("/index.html*", "anon");
        filterChainDefinitionMap.put("/resources/**", "anon");
        // 需要认证
        filterChainDefinitionMap.put("/**", "authc");
        
        factoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);
        return factoryBean;
    }
}
```

#### 3.1.2 UserRealm 认证授权

**认证流程** (doGetAuthenticationInfo):
1. 根据登录名查询用户
2. 判断用户是否存在
3. 返回认证信息（由凭证匹配器验证密码）

**授权流程** (doGetAuthorizationInfo):
1. 获取当前登录用户
2. 查询用户的角色
3. 根据角色查询权限
4. 返回授权信息

#### 3.1.3 密码加密

```java
// 新增用户时加密
String salt = IdUtil.simpleUUID().toUpperCase();
Md5Hash md5Hash = new Md5Hash(
    Constast.USER_DEFAULT_PWD,  // 默认密码 123456
    salt,                        // 盐值
    2                            // 散列次数
);
user.setSalt(salt);
user.setPwd(md5Hash.toHex());
```

### 3.2 MyBatis-Plus 集成

#### 3.2.1 配置类

**文件**: `MybatisPlusConfig.java`

```java
@Configuration
public class MybatisPlusConfig {
    // 分页插件
    @Bean
    public PaginationInterceptor paginationInterceptor() {
        return new PaginationInterceptor();
    }
}
```

#### 3.2.2 Mapper 接口

```java
@Mapper
public interface GoodsMapper extends BaseMapper<Goods> {
    // 继承 BaseMapper，自动拥有 CRUD 方法
    // insert, deleteById, updateById, selectById, selectList 等
}
```

#### 3.2.3 Service 层

```java
@Service
public class GoodsServiceImpl 
    extends ServiceImpl<GoodsMapper, Goods> 
    implements GoodsService {
    
    // 继承 ServiceImpl，获得增强的业务方法
    // save, saveOrUpdate, removeById, page, list 等
}
```

### 3.3 业务逻辑实现

#### 3.3.1 进货管理 (库存增加)

**文件**: `InportController.java`

```java
@RequestMapping("addInport")
public ResultObj addInport(InportVo inportVo) {
    try {
        // 1. 查询商品信息
        QueryWrapper<Goods> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("id", inportVo.getGoodsid());
        Goods goods = goodsService.getOne(queryWrapper);
        
        // 2. 更新库存（增加）
        goods.setNumber(goods.getNumber() + inportVo.getNumber());
        goodsService.updateById(goods);
        
        // 3. 记录进货信息
        inportVo.setInporttime(new Date());
        User user = (User) WebUtils.getSession().getAttribute("user");
        inportVo.setOperateperson(user.getName());
        this.inportService.save(inportVo);
        
        return ResultObj.ADD_SUCCESS;
    } catch (Exception e) {
        e.printStackTrace();
        return ResultObj.ADD_ERROR;
    }
}
```

#### 3.3.2 退货管理 (库存减少)

**文件**: `OutportController.java`

```java
@RequestMapping("addOutport")
public ResultObj addOutport(Integer id, Integer number, String remark) {
    try {
        // 1. 根据进货单ID查询进货信息
        QueryWrapper<Inport> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("id", id);
        Inport inport = inportService.getOne(queryWrapper);
        
        // 2. 查询商品并减少库存
        QueryWrapper<Goods> queryWrapper1 = new QueryWrapper<>();
        queryWrapper1.eq("id", inport.getGoodsid());
        Goods goods = goodsService.getOne(queryWrapper1);
        goods.setNumber(goods.getNumber() - number);
        goodsService.updateById(goods);
        
        // 3. 添加退货记录
        this.outportService.addOutPort(id, number, remark);
        
        return ResultObj.OPERATE_SUCCESS;
    } catch (Exception e) {
        e.printStackTrace();
        return ResultObj.OPERATE_ERROR;
    }
}
```

#### 3.3.3 用户名转拼音

**文件**: `UserController.java`

```java
@RequestMapping("changeChineseToPinyin")
public ResultObj changeChineseToPinyin(String username) {
    // 使用 Pinyin4j 将中文姓名转换为拼音
    String pinyin = PinyinUtils.getPinyin(username);
    return new ResultObj(200, pinyin);
}
```

**工具类**: `PinyinUtils.java`

```java
public class PinyinUtils {
    public static String getPinyin(String chinese) {
        StringBuilder pinyin = new StringBuilder();
        char[] chars = chinese.toCharArray();
        for (char c : chars) {
            if (c > 128) {
                try {
                    String[] pinyinArray = PinyinHelper.toHanyuPinyinStringArray(c);
                    if (pinyinArray != null) {
                        pinyin.append(pinyinArray[0].substring(0, 1));
                    }
                } catch (Exception e) {
                    pinyin.append(c);
                }
            } else {
                pinyin.append(c);
            }
        }
        return pinyin.toString().toLowerCase();
    }
}
```

### 3.4 前端实现

#### 3.4.1 数据表格

```javascript
// LayUI 表格渲染
var tableIns = table.render({
    elem: '#goodsTable',
    url: '/goods/loadAllGoods',
    method: 'post',
    page: true,
    cols: [[
        {type: 'checkbox', fixed: 'left'},
        {field: 'id', title: 'ID', align: 'center'},
        {field: 'goodsname', title: '商品名称', align: 'center'},
        {field: 'number', title: '库存', align: 'center'},
        {fixed: 'right', title: '操作', toolbar: '#goodsRowBar', align: 'center'}
    ]]
});
```

#### 3.4.2 树形菜单

```javascript
// dtree 树形组件
dtree.render({
    elem: "#menuTree",
    url: "/menu/loadMenuManagerLeftTreeJson",
    dataStyle: "layuiStyle",
    dataFormat: "list",
    response: {message: "msg", statusCode: 0},
    checkbar: true,
    checkbarType: "all"
});

// 监听节点点击
dtree.on("node(menuTree)", function(obj) {
    var nodeId = obj.param.nodeId;
    // 处理点击事件
});
```

#### 3.4.3 表单提交

```javascript
// 表单提交
form.on("submit(doSubmit)", function(data) {
    $.post(
        "/goods/addGoods",
        data.field,
        function(res) {
            layer.msg(res.msg);
            if(res.code == 200) {
                tableIns.reload();
                layer.close(mainIndex);
            }
        }
    );
    return false;
});
```

---

## 4. 数据库设计

### 4.1 数据库 ER 图

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  sys_user   │────────>│sys_user_role│<────────│  sys_role   │
│   (用户)     │   N:M   │  (用户角色)  │   N:M   │   (角色)     │
└─────────────┘         └─────────────┘         └──────┬──────┘
      │                                                 │
      │                                                 │
      │                 ┌─────────────┐                │
      │                 │ sys_role_   │                │
      └────────────────>│ permission  │<───────────────┘
                        │ (角色权限)   │
                        └──────┬──────┘
                               │
                        ┌──────┴──────┐
                        │sys_permission│
                        │   (权限)      │
                        └─────────────┘
```

### 4.2 核心表结构

#### 4.2.1 用户表 (sys_user)

```sql
CREATE TABLE `sys_user` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(255) DEFAULT NULL COMMENT '用户姓名',
  `loginname` varchar(255) DEFAULT NULL COMMENT '登录名',
  `address` varchar(255) DEFAULT NULL COMMENT '地址',
  `sex` int DEFAULT NULL COMMENT '性别[1=男,2=女]',
  `remark` varchar(255) DEFAULT NULL COMMENT '备注',
  `pwd` varchar(255) DEFAULT NULL COMMENT '密码',
  `deptid` int DEFAULT NULL COMMENT '部门ID',
  `hiredate` datetime DEFAULT NULL COMMENT '入职时间',
  `mgr` int DEFAULT NULL COMMENT '直属领导ID',
  `available` int DEFAULT NULL COMMENT '是否可用[1=可用,0=不可用]',
  `ordernum` int DEFAULT NULL COMMENT '排序码',
  `type` int DEFAULT NULL COMMENT '用户类型[0=超级管理员,1=普通用户]',
  `imgpath` varchar(255) DEFAULT NULL COMMENT '头像路径',
  `salt` varchar(255) DEFAULT NULL COMMENT '盐值',
  `tel` varchar(255) DEFAULT NULL COMMENT '电话',
  PRIMARY KEY (`id`)
);
```

#### 4.2.2 角色表 (sys_role)

```sql
CREATE TABLE `sys_role` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(255) DEFAULT NULL COMMENT '角色名称',
  `remark` varchar(255) DEFAULT NULL COMMENT '备注',
  `available` int DEFAULT NULL COMMENT '是否可用',
  `createtime` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`id`)
);
```

#### 4.2.3 权限表 (sys_permission)

```sql
CREATE TABLE `sys_permission` (
  `id` int NOT NULL AUTO_INCREMENT,
  `pid` int DEFAULT NULL COMMENT '父级ID',
  `type` varchar(255) DEFAULT NULL COMMENT '权限类型[menu/permission]',
  `title` varchar(255) DEFAULT NULL COMMENT '标题',
  `percode` varchar(255) DEFAULT NULL COMMENT '权限编码',
  `icon` varchar(255) DEFAULT NULL COMMENT '图标',
  `href` varchar(255) DEFAULT NULL COMMENT '链接地址',
  `target` varchar(255) DEFAULT NULL COMMENT '目标',
  `open` int DEFAULT NULL COMMENT '是否展开',
  `ordernum` int DEFAULT NULL COMMENT '排序码',
  `available` int DEFAULT NULL COMMENT '状态[0不可用,1可用]',
  PRIMARY KEY (`id`)
);
```

#### 4.2.4 商品表 (bus_goods)

```sql
CREATE TABLE `bus_goods` (
  `id` int NOT NULL AUTO_INCREMENT,
  `goodsname` varchar(255) DEFAULT NULL COMMENT '商品名称',
  `produceplace` varchar(255) DEFAULT NULL COMMENT '产地',
  `size` varchar(255) DEFAULT NULL COMMENT '规格',
  `goodspackage` varchar(255) DEFAULT NULL COMMENT '包装',
  `productcode` varchar(255) DEFAULT NULL COMMENT '商品编码',
  `promitcode` varchar(255) DEFAULT NULL COMMENT '批准文号',
  `price` double DEFAULT NULL COMMENT '价格',
  `number` int DEFAULT NULL COMMENT '库存数量',
  `danwei` varchar(255) DEFAULT NULL COMMENT '单位',
  `goodsimg` varchar(255) DEFAULT NULL COMMENT '商品图片',
  `goodsdesc` varchar(255) DEFAULT NULL COMMENT '商品描述',
  `available` int DEFAULT NULL COMMENT '是否可用',
  `providerid` int DEFAULT NULL COMMENT '供应商ID',
  PRIMARY KEY (`id`)
);
```

#### 4.2.5 进货表 (bus_inport)

```sql
CREATE TABLE `bus_inport` (
  `id` int NOT NULL AUTO_INCREMENT,
  `paytype` varchar(255) DEFAULT NULL COMMENT '支付类型',
  `inporttime` datetime DEFAULT NULL COMMENT '进货时间',
  `operateperson` varchar(255) DEFAULT NULL COMMENT '操作人',
  `number` int DEFAULT NULL COMMENT '数量',
  `remark` varchar(255) DEFAULT NULL COMMENT '备注',
  `inportprice` double DEFAULT NULL COMMENT '进货价格',
  `providerid` int DEFAULT NULL COMMENT '供应商ID',
  `goodsid` int DEFAULT NULL COMMENT '商品ID',
  PRIMARY KEY (`id`)
);
```

### 4.3 关系说明

1. **用户-角色**: 多对多关系，通过 `sys_user_role` 中间表关联
2. **角色-权限**: 多对多关系，通过 `sys_role_permission` 中间表关联
3. **用户-部门**: 多对一关系，用户属于一个部门
4. **商品-供应商**: 多对一关系，商品由一个供应商提供
5. **进货-商品**: 多对一关系，一次进货对应一个商品
6. **进货-供应商**: 多对一关系，一次进货对应一个供应商

---

## 5. API 接口文档

### 5.1 用户管理接口

#### 5.1.1 用户登录

**接口**: `POST /login/login`

**请求参数**:
```json
{
  "loginname": "system",
  "pwd": "123456",
  "code": "ABCD"
}
```

**返回数据**:
```json
{
  "code": 200,
  "msg": "登录成功",
  "token": null
}
```

#### 5.1.2 查询用户列表

**接口**: `POST /user/loadAllUser`

**请求参数**:
```json
{
  "page": 1,
  "limit": 10,
  "name": "张三",
  "deptid": 1
}
```

**返回数据**:
```json
{
  "code": 0,
  "msg": "",
  "count": 100,
  "data": [
    {
      "id": 1,
      "name": "张三",
      "loginname": "zhangsan",
      "deptid": 1,
      "available": 1
    }
  ]
}
```

### 5.2 商品管理接口

#### 5.2.1 查询商品列表

**接口**: `POST /goods/loadAllGoods`

**请求参数**:
```json
{
  "page": 1,
  "limit": 10,
  "goodsname": "商品A",
  "providerid": 1
}
```

**返回数据**:
```json
{
  "code": 0,
  "msg": "",
  "count": 50,
  "data": [
    {
      "id": 1,
      "goodsname": "商品A",
      "number": 100,
      "price": 50.0,
      "providerid": 1,
      "providername": "供应商A"
    }
  ]
}
```

#### 5.2.2 添加商品

**接口**: `POST /goods/addGoods`

**请求参数**:
```json
{
  "goodsname": "新商品",
  "produceplace": "北京",
  "size": "500g",
  "price": 99.0,
  "number": 100,
  "providerid": 1
}
```

**返回数据**:
```json
{
  "code": 200,
  "msg": "添加成功"
}
```

### 5.3 进货管理接口

#### 5.3.1 查询进货记录

**接口**: `POST /inport/loadAllInport`

**请求参数**:
```json
{
  "page": 1,
  "limit": 10,
  "providerid": 1,
  "goodsid": 1,
  "startTime": "2024-01-01",
  "endTime": "2024-12-31"
}
```

**返回数据**:
```json
{
  "code": 0,
  "msg": "",
  "count": 20,
  "data": [
    {
      "id": 1,
      "goodsid": 1,
      "goodsname": "商品A",
      "providerid": 1,
      "providername": "供应商A",
      "number": 50,
      "inporttime": "2024-01-15 10:30:00",
      "operateperson": "张三"
    }
  ]
}
```

#### 5.3.2 添加进货记录

**接口**: `POST /inport/addInport`

**请求参数**:
```json
{
  "goodsid": 1,
  "providerid": 1,
  "number": 100,
  "inportprice": 45.0,
  "paytype": "现金",
  "remark": "进货备注"
}
```

**返回数据**:
```json
{
  "code": 200,
  "msg": "添加成功"
}
```

### 5.4 权限管理接口

#### 5.4.1 查询菜单树

**接口**: `GET /menu/loadIndexLeftMenuJson`

**返回数据**:
```json
{
  "code": 0,
  "msg": "",
  "data": [
    {
      "id": 1,
      "pid": 0,
      "title": "仓库物流管理系统",
      "icon": "&#xe668;",
      "children": [
        {
          "id": 2,
          "pid": 1,
          "title": "基础管理",
          "icon": "&#xe857;"
        }
      ]
    }
  ]
}
```

#### 5.4.2 分配角色权限

**接口**: `POST /role/saveRolePermission`

**请求参数**:
```
rid=1&ids=1&ids=2&ids=3
```

**返回数据**:
```json
{
  "code": 200,
  "msg": "分配成功"
}
```

---

## 6. 安全机制

### 6.1 认证机制

1. **用户登录认证**
   - 用户输入用户名、密码、验证码
   - 后端验证验证码
   - Shiro 进行用户认证
   - 认证成功后将用户信息存入 Session

2. **Session 管理**
   - 默认超时时间: 30分钟
   - Session 存储用户信息
   - 登出时清除 Session

### 6.2 授权机制

1. **URL 过滤**
   - 静态资源放行: `/resources/**`
   - 登录接口放行: `/login/login`
   - 其他接口需要认证

2. **注解授权**
```java
@RequiresPermissions("user:create")
public ResultObj addUser(UserVo userVo) {
    // 需要 user:create 权限才能访问
}
```

### 6.3 密码安全

1. **加密算法**: MD5
2. **加密次数**: 2次散列
3. **加盐处理**: 每个用户独立盐值
4. **默认密码**: 123456 (建议首次登录修改)

### 6.4 SQL 注入防护

- MyBatis-Plus 预编译 SQL
- Druid SQL 防火墙
- 参数化查询

### 6.5 XSS 防护

- Thymeleaf 自动转义
- LayUI 表单验证
- 后端数据验证

---

## 7. 部署指南

### 7.1 开发环境部署

**步骤**:
1. 安装 JDK 1.8
2. 安装 Maven 3.6+
3. 安装 MySQL 5.7+
4. 导入数据库 `sql/warehouse.sql`
5. 修改 `application.yml` 数据库配置
6. 运行 `mvn spring-boot:run`

### 7.2 生产环境部署

#### 7.2.1 打包

```bash
mvn clean package -DskipTests
```

生成文件: `target/warehouse-0.0.1-SNAPSHOT.jar`

#### 7.2.2 运行

```bash
java -jar warehouse-0.0.1-SNAPSHOT.jar
```

#### 7.2.3 后台运行

```bash
nohup java -jar warehouse-0.0.1-SNAPSHOT.jar > output.log 2>&1 &
```

#### 7.2.4 Nginx 反向代理

```nginx
server {
    listen 80;
    server_name warehouse.example.com;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 7.3 性能优化建议

1. **数据库优化**
   - 添加索引 (user.loginname, goods.goodsname)
   - 定期清理日志表
   - 开启查询缓存

2. **连接池优化**
```yaml
spring:
  datasource:
    druid:
      initial-size: 5
      max-active: 20
      min-idle: 5
      max-wait: 60000
```

3. **缓存优化**
   - 菜单数据使用 Redis 缓存
   - 用户权限信息缓存

4. **静态资源**
   - 使用 CDN 加速
   - 开启 Gzip 压缩

---

## 8. 常见问题

### 8.1 数据库连接失败

**问题**: `Could not create connection to database server`

**解决**:
1. 检查 MySQL 服务是否启动
2. 确认数据库账号密码正确
3. 检查数据库 URL 是否正确
4. 确认 MySQL 驱动版本匹配

### 8.2 Shiro 权限验证失败

**问题**: `UnauthorizedException`

**解决**:
1. 检查用户是否已登录
2. 确认用户拥有对应权限
3. 检查权限编码是否正确

### 8.3 端口被占用

**问题**: `Port 8080 was already in use`

**解决**:
```yaml
# 修改端口
server:
  port: 8081
```

---

## 附录

### A. 常量定义

**文件**: `Constast.java`

```java
// 状态码
public static final Integer OK = 200;
public static final Integer ERROR = -1;

// 用户默认密码
public static final String USER_DEFAULT_PWD = "123456";

// 菜单权限类型
public static final String TYPE_MNEU = "menu";
public static final String TYPE_PERMISSION = "permission";

// 可用状态
public static final Object AVAILABLE_TRUE = 1;
public static final Object AVAILABLE_FALSE = 0;

// 用户类型
public static final Integer USER_TYPE_SUPER = 0;  // 超级管理员
public static final Integer USER_TYPE_NORMAL = 1; // 普通用户
```

### B. 返回对象

**文件**: `ResultObj.java`

```java
public static final ResultObj ADD_SUCCESS = new ResultObj(OK, "添加成功");
public static final ResultObj ADD_ERROR = new ResultObj(ERROR, "添加失败");
public static final ResultObj UPDATE_SUCCESS = new ResultObj(OK, "更新成功");
public static final ResultObj UPDATE_ERROR = new ResultObj(ERROR, "更新失败");
public static final ResultObj DELETE_SUCCESS = new ResultObj(OK, "删除成功");
public static final ResultObj DELETE_ERROR = new ResultObj(ERROR, "删除失败");
```

---
# ä»“åº“ç‰©æµç®¡ç†ç³»ç»Ÿ - ä¼˜åŒ–å»ºè®®ä¸æ”¹è¿›æ–¹å‘

## ç›®å½•

- [1. ä»£ç è´¨é‡ä¼˜åŒ–](#1-ä»£ç è´¨é‡ä¼˜åŒ–)
- [2. æ€§èƒ½ä¼˜åŒ–](#2-æ€§èƒ½ä¼˜åŒ–)
- [3. å®‰å…¨æ€§å¢å¼º](#3-å®‰å…¨æ€§å¢å¼º)
- [4. åŠŸèƒ½æ‰©å±•å»ºè®®](#4-åŠŸèƒ½æ‰©å±•å»ºè®®)
- [5. æ¶æ„å‡çº§å»ºè®®](#5-æ¶æ„å‡çº§å»ºè®®)
- [6. ç”¨æˆ·ä½“éªŒä¼˜åŒ–](#6-ç”¨æˆ·ä½“éªŒä¼˜åŒ–)
- [7. è¿ç»´ä¸ç›‘æ§](#7-è¿ç»´ä¸ç›‘æ§)
- [8. æŠ€æœ¯å€ºåŠ¡æ¸…ç†](#8-æŠ€æœ¯å€ºåŠ¡æ¸…ç†)

---

## 1. ä»£ç è´¨é‡ä¼˜åŒ–

### 1.1 å½“å‰é—®é¢˜

#### âŒ é—®é¢˜ 1: ä¸šåŠ¡é€»è¾‘åœ¨ Controller å±‚
```java
// InportController.java - ä¸æ¨è
@RequestMapping("addInport")
public ResultObj addInport(InportVo inportVo) {
    // åº“å­˜å˜åŒ–é€»è¾‘åœ¨ Controller
    Goods goods = goodsService.getOne(queryWrapper);
    goods.setNumber(goods.getNumber() + inportVo.getNumber());
    goodsService.updateById(goods);
    inportService.save(inportVo);
}
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ: ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° Service å±‚
```java
// InportService.java - æ¨è
@Service
@Transactional
public class InportServiceImpl {
    public void addInport(InportVo inportVo) {
        // 1. ä¿å­˜è¿›è´§è®°å½•
        this.save(inportVo);
        
        // 2. æ›´æ–°åº“å­˜
        goodsService.increaseStock(
            inportVo.getGoodsid(), 
            inportVo.getNumber()
        );
        
        // 3. è®°å½•åº“å­˜å˜åŠ¨æ—¥å¿—
        stockLogService.recordInport(inportVo);
    }
}

// Controller åªè´Ÿè´£å‚æ•°æ¥æ”¶å’Œè¿”å›
@RequestMapping("addInport")
public ResultObj addInport(InportVo inportVo) {
    inportService.addInport(inportVo);
    return ResultObj.ADD_SUCCESS;
}
```

**ä¼˜åŒ–æ”¶ç›Š**:
- âœ… ä¸šåŠ¡é€»è¾‘å¤ç”¨
- âœ… ä¾¿äºå•å…ƒæµ‹è¯•
- âœ… ä»£ç èŒè´£æ¸…æ™°

---

### 1.2 å¼‚å¸¸å¤„ç†ä¼˜åŒ–

#### âŒ å½“å‰é—®é¢˜: åæ‰å¼‚å¸¸ä¿¡æ¯
```java
try {
    // ä¸šåŠ¡é€»è¾‘
    return ResultObj.ADD_SUCCESS;
} catch (Exception e) {
    e.printStackTrace();  // ä»…æ‰“å°åˆ°æ§åˆ¶å°
    return ResultObj.ADD_ERROR;
}
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ: ç»Ÿä¸€å¼‚å¸¸å¤„ç†
```java
// å…¨å±€å¼‚å¸¸å¤„ç†å™¨
@ControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    @ResponseBody
    public ResultObj handleBusinessException(BusinessException e) {
        log.error("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage(), e);
        return new ResultObj(ResultObj.ERROR, e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    @ResponseBody
    public ResultObj handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸: {}", e.getMessage(), e);
        return new ResultObj(ResultObj.ERROR, "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
    }
}

// Service å±‚ç›´æ¥æŠ›å‡ºå¼‚å¸¸
public void addInport(InportVo inportVo) {
    if (inportVo.getNumber() <= 0) {
        throw new BusinessException("è¿›è´§æ•°é‡å¿…é¡»å¤§äº0");
    }
    // ä¸šåŠ¡é€»è¾‘
}
```

**ä¼˜åŒ–æ”¶ç›Š**:
- âœ… å¼‚å¸¸ä¿¡æ¯è®°å½•åˆ°æ—¥å¿—
- âœ… ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
- âœ… ä¾¿äºé—®é¢˜è¿½è¸ª

---

### 1.3 å‚æ•°æ ¡éªŒä¼˜åŒ–

#### âŒ å½“å‰é—®é¢˜: ç¼ºå°‘åç«¯æ ¡éªŒ
```java
@RequestMapping("addInport")
public ResultObj addInport(InportVo inportVo) {
    // ç¼ºå°‘å‚æ•°æ ¡éªŒ
    inportService.save(inportVo);
}
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ: ä½¿ç”¨ JSR-303 æ ¡éªŒ
```java
// Vo å¯¹è±¡æ·»åŠ æ ¡éªŒæ³¨è§£
public class InportVo {
    @NotNull(message = "å•†å“IDä¸èƒ½ä¸ºç©º")
    private Integer goodsid;
    
    @NotNull(message = "ä¾›åº”å•†IDä¸èƒ½ä¸ºç©º")
    private Integer providerid;
    
    @Min(value = 1, message = "è¿›è´§æ•°é‡å¿…é¡»å¤§äº0")
    private Integer number;
    
    @DecimalMin(value = "0.01", message = "è¿›è´§ä»·æ ¼å¿…é¡»å¤§äº0")
    private Double inportprice;
}

// Controller æ·»åŠ  @Valid æ³¨è§£
@RequestMapping("addInport")
public ResultObj addInport(@Valid InportVo inportVo, BindingResult result) {
    if (result.hasErrors()) {
        return new ResultObj(ResultObj.ERROR, result.getFieldError().getDefaultMessage());
    }
    inportService.addInport(inportVo);
    return ResultObj.ADD_SUCCESS;
}
```

**ä¼˜åŒ–æ”¶ç›Š**:
- âœ… æ•°æ®å®Œæ•´æ€§ä¿è¯
- âœ… å‡å°‘æ— æ•ˆæ•°æ®åº“æ“ä½œ
- âœ… æå‡ç”¨æˆ·ä½“éªŒ

---

### 1.4 æ—¥å¿—è§„èŒƒä¼˜åŒ–

#### âŒ å½“å‰é—®é¢˜: ä½¿ç”¨ System.out æˆ– e.printStackTrace()
```java
System.out.println("id:" + inport.getGoodsid());
e.printStackTrace();
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ: ä½¿ç”¨ SLF4J + Logback
```java
@Slf4j
@Service
public class InportServiceImpl {
    public void addInport(InportVo inportVo) {
        log.info("å¼€å§‹æ·»åŠ è¿›è´§è®°å½•, goodsId={}, number={}", 
            inportVo.getGoodsid(), inportVo.getNumber());
        
        try {
            // ä¸šåŠ¡é€»è¾‘
            log.info("è¿›è´§è®°å½•æ·»åŠ æˆåŠŸ, id={}", inport.getId());
        } catch (Exception e) {
            log.error("è¿›è´§è®°å½•æ·»åŠ å¤±è´¥, inportVo={}", inportVo, e);
            throw e;
        }
    }
}
```

**æ—¥å¿—çº§åˆ«è§„èŒƒ**:
- `ERROR`: ç³»ç»Ÿé”™è¯¯ï¼Œéœ€è¦ç«‹å³å¤„ç†
- `WARN`: è­¦å‘Šä¿¡æ¯ï¼Œå¦‚åº“å­˜ä¸è¶³
- `INFO`: é‡è¦ä¸šåŠ¡æ“ä½œï¼Œå¦‚è®¢å•åˆ›å»º
- `DEBUG`: è°ƒè¯•ä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒå…³é—­

---

### 1.5 Magic Number æ¶ˆé™¤

#### âŒ å½“å‰é—®é¢˜: ç¡¬ç¼–ç æ•°å­—
```java
if (user.getType() == 0) {  // 0 ä»£è¡¨ä»€ä¹ˆï¼Ÿ
    // è¶…çº§ç®¡ç†å‘˜é€»è¾‘
}

if (permission.getAvailable() == 1) {  // 1 ä»£è¡¨ä»€ä¹ˆï¼Ÿ
    // å¯ç”¨æƒé™
}
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ: ä½¿ç”¨æšä¸¾
```java
// ç”¨æˆ·ç±»å‹æšä¸¾
public enum UserType {
    SUPER_ADMIN(0, "è¶…çº§ç®¡ç†å‘˜"),
    NORMAL_USER(1, "æ™®é€šç”¨æˆ·");
    
    private Integer code;
    private String desc;
}

// å¯ç”¨çŠ¶æ€æšä¸¾
public enum AvailableStatus {
    DISABLED(0, "ä¸å¯ç”¨"),
    ENABLED(1, "å¯ç”¨");
    
    private Integer code;
    private String desc;
}

// ä½¿ç”¨
if (UserType.SUPER_ADMIN.getCode().equals(user.getType())) {
    // è¶…çº§ç®¡ç†å‘˜é€»è¾‘
}
```

---

## 2. æ€§èƒ½ä¼˜åŒ–

### 2.1 æ•°æ®åº“ä¼˜åŒ–

#### 2.1.1 æ·»åŠ ç´¢å¼•

**å½“å‰é—®é¢˜**: ç¼ºå°‘å¿…è¦ç´¢å¼•ï¼ŒæŸ¥è¯¢æ…¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```sql
-- ç”¨æˆ·è¡¨
ALTER TABLE sys_user ADD INDEX idx_loginname (loginname);
ALTER TABLE sys_user ADD INDEX idx_deptid (deptid);

-- å•†å“è¡¨
ALTER TABLE bus_goods ADD INDEX idx_goodsname (goodsname);
ALTER TABLE bus_goods ADD INDEX idx_providerid (providerid);

-- è¿›è´§è¡¨
ALTER TABLE bus_inport ADD INDEX idx_goodsid (goodsid);
ALTER TABLE bus_inport ADD INDEX idx_inporttime (inporttime);
ALTER TABLE bus_inport ADD INDEX idx_providerid_goodsid (providerid, goodsid);

-- å¤åˆç´¢å¼•ç”¨äºå¸¸ç”¨ç»„åˆæŸ¥è¯¢
```

**ä¼˜åŒ–æ”¶ç›Š**: æŸ¥è¯¢æ€§èƒ½æå‡ 50%-80%

---

#### 2.1.2 SQL ä¼˜åŒ–

**âŒ N+1 æŸ¥è¯¢é—®é¢˜**:
```java
// å½“å‰å®ç° - æ¯æ¬¡å¾ªç¯éƒ½æŸ¥è¯¢æ•°æ®åº“
List<Inport> records = page.getRecords();
for (Inport inport : records) {
    Provider provider = providerService.getById(inport.getProviderid());  // Næ¬¡æŸ¥è¯¢
    Goods goods = goodsService.getById(inport.getGoodsid());  // Næ¬¡æŸ¥è¯¢
}
```

**âœ… ä¼˜åŒ–æ–¹æ¡ˆ: æ‰¹é‡æŸ¥è¯¢**:
```java
List<Inport> records = page.getRecords();

// æ”¶é›†æ‰€æœ‰ID
Set<Integer> providerIds = records.stream()
    .map(Inport::getProviderid)
    .collect(Collectors.toSet());
Set<Integer> goodsIds = records.stream()
    .map(Inport::getGoodsid)
    .collect(Collectors.toSet());

// æ‰¹é‡æŸ¥è¯¢
Map<Integer, Provider> providerMap = providerService.listByIds(providerIds)
    .stream()
    .collect(Collectors.toMap(Provider::getId, p -> p));
Map<Integer, Goods> goodsMap = goodsService.listByIds(goodsIds)
    .stream()
    .collect(Collectors.toMap(Goods::getId, g -> g));

// å¡«å……æ•°æ®
for (Inport inport : records) {
    inport.setProvidername(providerMap.get(inport.getProviderid()).getProvidername());
    inport.setGoodsname(goodsMap.get(inport.getGoodsid()).getGoodsname());
}
```

**ä¼˜åŒ–æ”¶ç›Š**: æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ä» N+1 é™ä½åˆ° 3 æ¬¡

---

### 2.2 ç¼“å­˜ä¼˜åŒ–

#### 2.2.1 èœå•ç¼“å­˜

**å½“å‰é—®é¢˜**: æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥è¯¢æ•°æ®åº“

**ä¼˜åŒ–æ–¹æ¡ˆ**: ä½¿ç”¨ Redis ç¼“å­˜
```java
@Service
public class MenuServiceImpl {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public List<Permission> getMenuTree(Integer userId) {
        String cacheKey = "menu:user:" + userId;
        
        // å…ˆä»ç¼“å­˜è·å–
        List<Permission> menus = (List<Permission>) redisTemplate.opsForValue().get(cacheKey);
        if (menus != null) {
            return menus;
        }
        
        // ç¼“å­˜ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        menus = queryMenuFromDB(userId);
        
        // å­˜å…¥ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—´ 1 å°æ—¶
        redisTemplate.opsForValue().set(cacheKey, menus, 1, TimeUnit.HOURS);
        
        return menus;
    }
    
    // æƒé™å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜
    public void clearMenuCache(Integer userId) {
        redisTemplate.delete("menu:user:" + userId);
    }
}
```

---

#### 2.2.2 æœ¬åœ°ç¼“å­˜

**è½»é‡çº§æ•°æ®ç¼“å­˜**: ä½¿ç”¨ Caffeine
```java
@Configuration
public class CacheConfig {
    @Bean
    public CacheManager cacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(10, TimeUnit.MINUTES));
        return cacheManager;
    }
}

// ä½¿ç”¨
@Service
public class DictService {
    @Cacheable(value = "dictCache", key = "#dictType")
    public List<Dict> getDictByType(String dictType) {
        // æŸ¥è¯¢æ•°æ®åº“
    }
}
```

---

### 2.3 è¿æ¥æ± ä¼˜åŒ–

**å½“å‰é…ç½®**:
```yaml
spring:
  datasource:
    druid:
      initial-size: 1
      max-active: 20
```

**ä¼˜åŒ–é…ç½®**:
```yaml
spring:
  datasource:
    druid:
      initial-size: 5              # åˆå§‹è¿æ¥æ•°
      min-idle: 5                  # æœ€å°ç©ºé—²è¿æ¥
      max-active: 20               # æœ€å¤§æ´»è·ƒè¿æ¥
      max-wait: 60000              # è·å–è¿æ¥æœ€å¤§ç­‰å¾…æ—¶é—´(ms)
      time-between-eviction-runs-millis: 60000  # æ£€æµ‹ç©ºé—²è¿æ¥é—´éš”
      min-evictable-idle-time-millis: 300000    # è¿æ¥ç©ºé—²æœ€å°å­˜æ´»æ—¶é—´
      validation-query: SELECT 1   # éªŒè¯æŸ¥è¯¢
      test-while-idle: true        # ç©ºé—²æ—¶æ£€æµ‹
      test-on-borrow: false        # è·å–æ—¶ä¸æ£€æµ‹
      test-on-return: false        # å½’è¿˜æ—¶ä¸æ£€æµ‹
```

---

### 2.4 åˆ†é¡µä¼˜åŒ–

**å½“å‰é—®é¢˜**: å¤§æ•°æ®é‡åˆ†é¡µæŸ¥è¯¢æ…¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// 1. ä½¿ç”¨è¦†ç›–ç´¢å¼•
SELECT id FROM bus_inport WHERE ... LIMIT 10000, 10;  -- å¿«
SELECT * FROM bus_inport WHERE id IN (ä¸Šé¢æŸ¥è¯¢çš„ID);

// 2. ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èï¼‰
SELECT * FROM bus_inport WHERE id > #{lastId} ORDER BY id LIMIT 10;

// 3. ç¦æ­¢æ·±åº¦åˆ†é¡µ
if (page > 100) {
    throw new BusinessException("åˆ†é¡µè¿‡æ·±ï¼Œè¯·ä½¿ç”¨æœç´¢åŠŸèƒ½");
}
```

---

## 3. å®‰å…¨æ€§å¢å¼º

### 3.1 å¯†ç ç­–ç•¥å¢å¼º

**å½“å‰é—®é¢˜**: 
- é»˜è®¤å¯†ç  123456
- æ— å¯†ç å¼ºåº¦è¦æ±‚
- æ— å¯†ç è¿‡æœŸç­–ç•¥

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// 1. å¯†ç å¼ºåº¦æ ¡éªŒ
public class PasswordValidator {
    public static boolean validate(String password) {
        // è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
        String regex = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$";
        return password.matches(regex);
    }
}

// 2. å¼ºåˆ¶ä¿®æ”¹åˆå§‹å¯†ç 
public class User {
    private Boolean mustChangePassword;  // é¦–æ¬¡ç™»å½•å¿…é¡»ä¿®æ”¹å¯†ç 
    private Date passwordExpireTime;     // å¯†ç è¿‡æœŸæ—¶é—´
}

// 3. å¯†ç å†å²è®°å½•ï¼ˆé˜²æ­¢é‡å¤ä½¿ç”¨ï¼‰
CREATE TABLE sys_password_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    password VARCHAR(255),
    create_time DATETIME
);
```

---

### 3.2 æƒé™æ§åˆ¶ç»†åŒ–

**å½“å‰é—®é¢˜**: 
- ç¼ºå°‘æ•°æ®æƒé™æ§åˆ¶
- åªèƒ½æ§åˆ¶åˆ°èœå•çº§åˆ«

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// æ•°æ®æƒé™æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DataPermission {
    DataScope value() default DataScope.ALL;
}

public enum DataScope {
    ALL,        // æ‰€æœ‰æ•°æ®
    DEPT,       // æœ¬éƒ¨é—¨æ•°æ®
    DEPT_AND_CHILD,  // æœ¬éƒ¨é—¨åŠå­éƒ¨é—¨
    SELF        // ä»…æœ¬äººæ•°æ®
}

// AOP å®ç°æ•°æ®æƒé™
@Aspect
@Component
public class DataPermissionAspect {
    @Around("@annotation(dataPermission)")
    public Object around(ProceedingJoinPoint point, DataPermission dataPermission) {
        User user = getCurrentUser();
        
        // æ ¹æ®æ•°æ®æƒé™èŒƒå›´æ·»åŠ æŸ¥è¯¢æ¡ä»¶
        if (dataPermission.value() == DataScope.DEPT) {
            addDeptCondition(user.getDeptId());
        }
        
        return point.proceed();
    }
}
```

---

### 3.3 æ¥å£é˜²åˆ·

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// é™æµæ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    int limit() default 10;  // æ—¶é—´çª—å£å†…æœ€å¤§è¯·æ±‚æ•°
    int timeout() default 60;  // æ—¶é—´çª—å£(ç§’)
}

// Redis å®ç°é™æµ
@Aspect
@Component
public class RateLimitAspect {
    @Autowired
    private RedisTemplate<String, Integer> redisTemplate;
    
    @Around("@annotation(rateLimit)")
    public Object around(ProceedingJoinPoint point, RateLimit rateLimit) {
        String key = "rate_limit:" + getClientIP() + ":" + point.getSignature().getName();
        
        Integer count = redisTemplate.opsForValue().get(key);
        if (count != null && count >= rateLimit.limit()) {
            throw new BusinessException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        // è®¡æ•°
        if (count == null) {
            redisTemplate.opsForValue().set(key, 1, rateLimit.timeout(), TimeUnit.SECONDS);
        } else {
            redisTemplate.opsForValue().increment(key);
        }
        
        return point.proceed();
    }
}

// ä½¿ç”¨
@RateLimit(limit = 5, timeout = 60)
@RequestMapping("addGoods")
public ResultObj addGoods(GoodsVo goodsVo) {
    // 1åˆ†é’Ÿå†…æœ€å¤šè°ƒç”¨5æ¬¡
}
```

---

### 3.4 æ•æ„Ÿä¿¡æ¯è„±æ•

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```java
// æ•æ„Ÿä¿¡æ¯æ³¨è§£
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Sensitive {
    SensitiveType value();
}

public enum SensitiveType {
    PHONE,      // æ‰‹æœºå·: 137****8888
    ID_CARD,    // èº«ä»½è¯: 110***********1234
    BANK_CARD,  // é“¶è¡Œå¡: 6222*************234
    EMAIL       // é‚®ç®±: a**@example.com
}

// å®ä½“ç±»ä½¿ç”¨
public class Customer {
    @Sensitive(SensitiveType.PHONE)
    private String phone;
    
    @Sensitive(SensitiveType.ID_CARD)
    private String idCard;
}

// åºåˆ—åŒ–æ—¶è‡ªåŠ¨è„±æ•
@Component
public class SensitiveJsonSerializer extends JsonSerializer<String> {
    @Override
    public void serialize(String value, JsonGenerator gen, SerializerProvider serializers) 
        throws IOException {
        // æ ¹æ®æ³¨è§£ç±»å‹è¿›è¡Œè„±æ•
        gen.writeString(desensitize(value));
    }
}
```

---

## 4. åŠŸèƒ½æ‰©å±•å»ºè®®

### 4.1 åº“å­˜é¢„è­¦åŠŸèƒ½

**å®ç°æ–¹æ¡ˆ**:
```java
// å•†å“è¡¨æ·»åŠ å­—æ®µ
ALTER TABLE bus_goods ADD COLUMN min_stock INT COMMENT 'æœ€ä½åº“å­˜';
ALTER TABLE bus_goods ADD COLUMN max_stock INT COMMENT 'æœ€é«˜åº“å­˜';

// å®šæ—¶ä»»åŠ¡æ£€æŸ¥åº“å­˜
@Scheduled(cron = "0 0 9 * * ?")  // æ¯å¤©9ç‚¹æ£€æŸ¥
public void checkStock() {
    List<Goods> lowStockGoods = goodsService.list(
        new QueryWrapper<Goods>()
            .lt("number", "min_stock")
            .eq("available", 1)
    );
    
    if (!lowStockGoods.isEmpty()) {
        // å‘é€é¢„è­¦é€šçŸ¥
        notificationService.sendLowStockAlert(lowStockGoods);
    }
}
```

---

### 4.2 é”€å”®ç»Ÿè®¡åˆ†æ

**å®ç°æ–¹æ¡ˆ**:
```java
// é”€å”®ç»Ÿè®¡Service
@Service
public class SalesStatisticsService {
    
    // æŒ‰æ—¥æœŸç»Ÿè®¡é”€å”®é¢
    public List<SalesDTO> getSalesByDate(Date startDate, Date endDate) {
        return deliverMapper.selectSalesByDate(startDate, endDate);
    }
    
    // çƒ­é”€å•†å“æ’è¡Œ
    public List<GoodsRankDTO> getHotGoods(int topN) {
        return deliverMapper.selectHotGoods(topN);
    }
    
    // ä¾›åº”å•†è´¡çŒ®åº¦åˆ†æ
    public List<ProviderContributionDTO> getProviderContribution() {
        return inportMapper.selectProviderContribution();
    }
}

// å‰ç«¯å›¾è¡¨å±•ç¤ºï¼ˆEChartsï¼‰
```

---

### 4.3 å¯¼å…¥å¯¼å‡ºåŠŸèƒ½

**å®ç°æ–¹æ¡ˆ**:
```java
// ä½¿ç”¨ EasyExcel
@Service
public class ExcelService {
    
    // å¯¼å‡ºå•†å“åˆ—è¡¨
    public void exportGoods(HttpServletResponse response) throws IOException {
        List<Goods> goodsList = goodsService.list();
        
        response.setContentType("application/vnd.ms-excel");
        response.setCharacterEncoding("utf-8");
        String fileName = "å•†å“åˆ—è¡¨_" + DateUtil.format(new Date(), "yyyyMMdd") + ".xlsx";
        response.setHeader("Content-disposition", "attachment;filename=" + fileName);
        
        EasyExcel.write(response.getOutputStream(), Goods.class)
            .sheet("å•†å“åˆ—è¡¨")
            .doWrite(goodsList);
    }
    
    // å¯¼å…¥å•†å“æ•°æ®
    public void importGoods(MultipartFile file) throws IOException {
        EasyExcel.read(file.getInputStream(), Goods.class, new GoodsListener(goodsService))
            .sheet()
            .doRead();
    }
}
```

---

### 4.4 æ“ä½œæ—¥å¿—å®¡è®¡

**å®ç°æ–¹æ¡ˆ**:
```java
// æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE sys_operation_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INT COMMENT 'æ“ä½œç”¨æˆ·',
    user_name VARCHAR(50) COMMENT 'ç”¨æˆ·å',
    operation VARCHAR(50) COMMENT 'æ“ä½œç±»å‹',
    method VARCHAR(200) COMMENT 'è¯·æ±‚æ–¹æ³•',
    params TEXT COMMENT 'è¯·æ±‚å‚æ•°',
    ip VARCHAR(50) COMMENT 'IPåœ°å€',
    create_time DATETIME COMMENT 'æ“ä½œæ—¶é—´'
);

// AOP è®°å½•æ—¥å¿—
@Aspect
@Component
@Slf4j
public class OperationLogAspect {
    @Autowired
    private OperationLogService operationLogService;
    
    @Around("@annotation(operationLog)")
    public Object around(ProceedingJoinPoint point, OperationLog operationLog) {
        OperationLogEntity log = new OperationLogEntity();
        log.setOperation(operationLog.value());
        log.setMethod(point.getSignature().getName());
        log.setParams(JSON.toJSONString(point.getArgs()));
        log.setIp(getClientIP());
        log.setCreateTime(new Date());
        
        Object result = point.proceed();
        
        operationLogService.save(log);
        return result;
    }
}

// ä½¿ç”¨
@OperationLog("æ·»åŠ å•†å“")
@RequestMapping("addGoods")
public ResultObj addGoods(GoodsVo goodsVo) {
    // ...
}
```

---

### 4.5 ç§»åŠ¨ç«¯æ”¯æŒ

**å®ç°æ–¹æ¡ˆ**:
```java
// 1. RESTful API æ”¹é€ 
@RestController
@RequestMapping("/api/v1/goods")
public class GoodsApiController {
    
    @GetMapping("/{id}")
    public Result<Goods> getById(@PathVariable Integer id) {
        return Result.success(goodsService.getById(id));
    }
    
    @PostMapping
    public Result<Void> add(@RequestBody @Valid GoodsVo goodsVo) {
        goodsService.save(goodsVo);
        return Result.success();
    }
}

// 2. JWT Token è®¤è¯
@Component
public class JwtTokenProvider {
    public String generateToken(User user) {
        return Jwts.builder()
            .setSubject(user.getId().toString())
            .setExpiration(new Date(System.currentTimeMillis() + 7 * 24 * 3600 * 1000))
            .signWith(SignatureAlgorithm.HS512, SECRET_KEY)
            .compact();
    }
}

// 3. è·¨åŸŸé…ç½®
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
            .allowedOrigins("*")
            .allowedMethods("GET", "POST", "PUT", "DELETE")
            .allowedHeaders("*");
    }
}
```

---

## 5. æ¶æ„å‡çº§å»ºè®®

### 5.1 å¾®æœåŠ¡æ”¹é€ 

**å½“å‰æ¶æ„**: å•ä½“åº”ç”¨  
**ç›®æ ‡æ¶æ„**: Spring Cloud å¾®æœåŠ¡

**æ”¹é€ æ­¥éª¤**:
```
1. æœåŠ¡æ‹†åˆ†
   â”œâ”€â”€ warehouse-auth (è®¤è¯æˆæƒæœåŠ¡)
   â”œâ”€â”€ warehouse-system (ç³»ç»Ÿç®¡ç†æœåŠ¡)
   â”œâ”€â”€ warehouse-goods (å•†å“ç®¡ç†æœåŠ¡)
   â”œâ”€â”€ warehouse-inport (è¿›è´§ç®¡ç†æœåŠ¡)
   â””â”€â”€ warehouse-deliver (å‘è´§ç®¡ç†æœåŠ¡)

2. åŸºç¡€è®¾æ–½
   â”œâ”€â”€ Nacos (æœåŠ¡æ³¨å†Œä¸é…ç½®ä¸­å¿ƒ)
   â”œâ”€â”€ Gateway (APIç½‘å…³)
   â”œâ”€â”€ Sentinel (æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§)
   â””â”€â”€ Seata (åˆ†å¸ƒå¼äº‹åŠ¡)

3. åˆ†å¸ƒå¼ç»„ä»¶
   â”œâ”€â”€ Redis (åˆ†å¸ƒå¼ç¼“å­˜)
   â”œâ”€â”€ RocketMQ (æ¶ˆæ¯é˜Ÿåˆ—)
   â””â”€â”€ XXL-Job (åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡)
```

---

### 5.2 è¯»å†™åˆ†ç¦»

**å®ç°æ–¹æ¡ˆ**:
```java
// 1. é…ç½®ä¸»ä»æ•°æ®æº
@Configuration
public class DataSourceConfig {
    @Bean
    @ConfigurationProperties("spring.datasource.master")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties("spring.datasource.slave")
    public DataSource slaveDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource dynamicDataSource() {
        DynamicDataSource dataSource = new DynamicDataSource();
        Map<Object, Object> targetDataSources = new HashMap<>();
        targetDataSources.put(DataSourceType.MASTER, masterDataSource());
        targetDataSources.put(DataSourceType.SLAVE, slaveDataSource());
        dataSource.setTargetDataSources(targetDataSources);
        dataSource.setDefaultTargetDataSource(masterDataSource());
        return dataSource;
    }
}

// 2. åŠ¨æ€åˆ‡æ¢æ•°æ®æº
@Aspect
@Component
public class DataSourceAspect {
    @Before("@annotation(dataSource)")
    public void switchDataSource(DataSource dataSource) {
        DataSourceContextHolder.setDataSourceType(dataSource.value());
    }
}

// 3. ä½¿ç”¨
@DataSource(DataSourceType.SLAVE)
public List<Goods> queryGoodsList() {
    // ä»ä»åº“æŸ¥è¯¢
}
```

---

### 5.3 æ¶ˆæ¯é˜Ÿåˆ—å¼•å…¥

**åœºæ™¯**: åº“å­˜å˜åŠ¨å¼‚æ­¥é€šçŸ¥ã€æ—¥å¿—å¼‚æ­¥å†™å…¥

**å®ç°æ–¹æ¡ˆ**:
```java
// 1. RabbitMQ é…ç½®
@Configuration
public class RabbitMQConfig {
    @Bean
    public Queue stockChangeQueue() {
        return new Queue("stock.change", true);
    }
}

// 2. å‘é€æ¶ˆæ¯
@Service
public class InportService {
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void addInport(InportVo inportVo) {
        // ä¿å­˜è¿›è´§è®°å½•
        inportService.save(inportVo);
        
        // å¼‚æ­¥å‘é€åº“å­˜å˜åŠ¨æ¶ˆæ¯
        StockChangeEvent event = new StockChangeEvent();
        event.setGoodsId(inportVo.getGoodsid());
        event.setChangeNumber(inportVo.getNumber());
        event.setType("INPORT");
        rabbitTemplate.convertAndSend("stock.change", event);
    }
}

// 3. æ¶ˆè´¹æ¶ˆæ¯
@Component
public class StockChangeListener {
    @RabbitListener(queues = "stock.change")
    public void handleStockChange(StockChangeEvent event) {
        // æ›´æ–°åº“å­˜
        // å‘é€é¢„è­¦é€šçŸ¥
        // è®°å½•æ—¥å¿—
    }
}
```

---

## 6. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 6.1 å‰ç«¯ä¼˜åŒ–

#### 6.1.1 å‡çº§åˆ°ç°ä»£å‰ç«¯æ¡†æ¶

**å½“å‰**: LayUI (å·²åœæ­¢ç»´æŠ¤)  
**å»ºè®®**: Vue 3 + Element Plus / React + Ant Design

**ä¼˜åŠ¿**:
- âœ… ç»„ä»¶åŒ–å¼€å‘
- âœ… æ›´å¥½çš„æ€§èƒ½
- âœ… æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ
- âœ… ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿ

---

#### 6.1.2 å“åº”å¼è®¾è®¡

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```css
/* ç§»åŠ¨ç«¯é€‚é… */
@media screen and (max-width: 768px) {
    .table-container {
        overflow-x: auto;
    }
    
    .form-item {
        width: 100%;
    }
}
```

---

#### 6.1.3 åŠ è½½ä¼˜åŒ–

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```javascript
// 1. æ‡’åŠ è½½
const routes = [
    {
        path: '/goods',
        component: () => import('./views/Goods.vue')
    }
];

// 2. éª¨æ¶å±
<div class="skeleton-loading" v-if="loading">
    <div class="skeleton-item"></div>
</div>

// 3. è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§æ•°æ®é‡ï¼‰
<virtual-list :data-sources="goodsList" :data-component="GoodsItem" />
```

---

### 6.2 äº¤äº’ä¼˜åŒ–

#### 6.2.1 è¡¨å•ä¼˜åŒ–

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```javascript
// 1. é˜²æŠ–æäº¤
const submitForm = debounce(() => {
    // æäº¤é€»è¾‘
}, 300);

// 2. è¡¨å•è‡ªåŠ¨ä¿å­˜ï¼ˆè‰ç¨¿ï¼‰
watchEffect(() => {
    localStorage.setItem('formDraft', JSON.stringify(formData));
});

// 3. è¡¨å•è”åŠ¨
watch(() => form.providerId, (newVal) => {
    // æ ¹æ®ä¾›åº”å•†è‡ªåŠ¨åŠ è½½å•†å“åˆ—è¡¨
    loadGoodsByProvider(newVal);
});
```

---

#### 6.2.2 æ¶ˆæ¯æç¤ºä¼˜åŒ–

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```javascript
// 1. ç»Ÿä¸€æ¶ˆæ¯é£æ ¼
const showMessage = {
    success: (msg) => ElMessage.success(msg),
    error: (msg) => ElMessage.error(msg),
    warning: (msg) => ElMessage.warning(msg)
};

// 2. åŠ è½½çŠ¶æ€
const loading = ref(false);

const submitForm = async () => {
    loading.value = true;
    try {
        await api.addGoods(formData);
        showMessage.success('æ·»åŠ æˆåŠŸ');
    } catch (error) {
        showMessage.error('æ·»åŠ å¤±è´¥');
    } finally {
        loading.value = false;
    }
};

// 3. ç¡®è®¤å¯¹è¯æ¡†
const deleteGoods = async (id) => {
    const confirmed = await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¯¥å•†å“å—ï¼Ÿ');
    if (confirmed) {
        // åˆ é™¤é€»è¾‘
    }
};
```

---

## 7. è¿ç»´ä¸ç›‘æ§

### 7.1 åº”ç”¨ç›‘æ§

**å®ç°æ–¹æ¡ˆ**: Spring Boot Actuator + Prometheus + Grafana

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: '*'  # æš´éœ²æ‰€æœ‰ç›‘æ§ç«¯ç‚¹
  metrics:
    export:
      prometheus:
        enabled: true
```

**ç›‘æ§æŒ‡æ ‡**:
- JVM å†…å­˜ã€CPUä½¿ç”¨ç‡
- æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
- æ¥å£å“åº”æ—¶é—´
- å¼‚å¸¸ç»Ÿè®¡

---

### 7.2 æ—¥å¿—æ”¶é›†

**å®ç°æ–¹æ¡ˆ**: ELK (Elasticsearch + Logstash + Kibana)

```xml
<!-- logback-spring.xml -->
<appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
    <destination>logstash:5000</destination>
    <encoder class="net.logstash.logback.encoder.LogstashEncoder" />
</appender>
```

---

### 7.3 å¥åº·æ£€æŸ¥

**å®ç°æ–¹æ¡ˆ**:
```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    @Override
    public Health health() {
        // æ£€æŸ¥æ•°æ®åº“è¿æ¥
        if (!checkDatabase()) {
            return Health.down().withDetail("database", "connection failed").build();
        }
        
        // æ£€æŸ¥Redisè¿æ¥
        if (!checkRedis()) {
            return Health.down().withDetail("redis", "connection failed").build();
        }
        
        return Health.up().build();
    }
}
```

---

## 8. æŠ€æœ¯å€ºåŠ¡æ¸…ç†

### 8.1 ä»£ç é‡æ„æ¸…å•

- [ ] Controller å±‚ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° Service
- [ ] ç»Ÿä¸€å¼‚å¸¸å¤„ç†æœºåˆ¶
- [ ] æ·»åŠ å‚æ•°æ ¡éªŒ
- [ ] æ¶ˆé™¤ Magic Number
- [ ] æ—¥å¿—è§„èŒƒåŒ–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡æå‡åˆ° 60%+

### 8.2 ä¾èµ–å‡çº§

**å½“å‰ç‰ˆæœ¬ â†’ ç›®æ ‡ç‰ˆæœ¬**:
- Spring Boot 2.1.8 â†’ 2.7.x (LTSç‰ˆæœ¬)
- MyBatis-Plus 3.2.0 â†’ 3.5.x
- Shiro 1.4.1 â†’ 1.10.x
- FastJSON 1.2.61 â†’ Jackson (å®‰å…¨è€ƒè™‘)
- Log4j â†’ Logback (æ€§èƒ½æ›´å¥½)

### 8.3 æ•°æ®åº“ä¼˜åŒ–æ¸…å•

- [ ] æ·»åŠ å¿…è¦ç´¢å¼•
- [ ] ä¼˜åŒ–æ…¢æŸ¥è¯¢
- [ ] å®šæœŸæ¸…ç†å†å²æ•°æ®
- [ ] æ•°æ®å½’æ¡£æ–¹æ¡ˆ
- [ ] ä¸»ä»å¤åˆ¶éƒ¨ç½²

---

## æ€»ç»“

æœ¬æ–‡æ¡£ä» **ä»£ç è´¨é‡**ã€**æ€§èƒ½**ã€**å®‰å…¨**ã€**åŠŸèƒ½æ‰©å±•**ã€**æ¶æ„å‡çº§**ã€**ç”¨æˆ·ä½“éªŒ**ã€**è¿ç»´ç›‘æ§**ã€**æŠ€æœ¯å€ºåŠ¡** å…«ä¸ªç»´åº¦æå‡ºäº†å…¨é¢çš„ä¼˜åŒ–å»ºè®®ã€‚

**ä¼˜å…ˆçº§å»ºè®®**:

ğŸ”´ **é«˜ä¼˜å…ˆçº§** (ç«‹å³æ‰§è¡Œ):
1. å¼‚å¸¸å¤„ç†ä¼˜åŒ–
2. å‚æ•°æ ¡éªŒ
3. æ—¥å¿—è§„èŒƒåŒ–
4. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
5. SQL N+1 é—®é¢˜è§£å†³

ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§** (3ä¸ªæœˆå†…):
1. ç¼“å­˜å¼•å…¥
2. ä»£ç é‡æ„
3. å•å…ƒæµ‹è¯•
4. åº“å­˜é¢„è­¦åŠŸèƒ½
5. æ“ä½œæ—¥å¿—å®¡è®¡

ğŸŸ¢ **ä½ä¼˜å…ˆçº§** (é•¿æœŸè§„åˆ’):
1. å¾®æœåŠ¡æ”¹é€ 
2. å‰ç«¯æ¡†æ¶å‡çº§
3. ç§»åŠ¨ç«¯æ”¯æŒ
4. æ¶ˆæ¯é˜Ÿåˆ—å¼•å…¥
5. è¯»å†™åˆ†ç¦»

**é¢„æœŸæ”¶ç›Š**:
- ğŸš€ æ€§èƒ½æå‡ 50%+
- ğŸ›¡ï¸ å®‰å…¨æ€§æ˜¾è‘—å¢å¼º
- ğŸ“Š å¯ç»´æŠ¤æ€§æé«˜
- ğŸ’° è¿ç»´æˆæœ¬é™ä½

---
